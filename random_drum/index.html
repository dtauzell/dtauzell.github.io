<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Drum Machine</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN with crossorigin attribute to prevent script errors -->
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js" crossorigin="anonymous"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate-900 */
            color: #e2e8f0; /* Slate-200 */
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #a78bfa;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        }
        /* CSS for the flashing effect */
        .flash {
            color: #a78bfa; /* Violet-400 */
            text-shadow: 0 0 8px rgba(167, 139, 250, 0.7);
            transition: color 0.1s ease, text-shadow 0.1s ease;
        }
    </style>
</head>
<body class="p-8 md:p-16 flex flex-col items-center min-h-screen">

    <!-- Main Container -->
    <div class="bg-slate-800 p-8 md:p-12 rounded-xl shadow-lg w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-violet-400">Random Drum Machine</h1>

        <!-- Controls Section -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
            <button id="generateBtn" class="bg-violet-700 hover:bg-violet-600 text-white font-bold py-2 px-6 rounded-lg shadow transition-colors">
                Generate New Pattern
            </button>
            <div class="flex items-center gap-4">
                <button id="playPauseBtn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow transition-colors">
                    Play
                </button>
                <div class="flex flex-col items-center">
                    <label for="tempoSlider" class="text-sm">Tempo</label>
                    <input type="range" id="tempoSlider" min="40" max="200" value="120" class="w-32 md:w-40">
                    <span id="tempoDisplay" class="text-xs text-slate-400">120 BPM</span>
                </div>
                <!-- New Measures Display -->
                <div class="flex flex-col items-center">
                    <label class="text-sm">Measures</label>
                    <span id="measuresDisplay" class="text-xs text-slate-400"></span>
                </div>
            </div>
        </div>

        <!-- Volume Sliders -->
        <div class="flex flex-col md:flex-row gap-8 justify-center">
            <div class="flex flex-col gap-4 w-full md:w-1/2">
                <div class="flex flex-col items-center">
                    <label id="kickLabel" for="kickVol" class="text-sm">Kick</label>
                    <input type="range" id="kickVol" min="-30" max="0" value="-6" class="w-full">
                </div>
                <div class="flex flex-col items-center">
                    <label id="snareLabel" for="snareVol" class="text-sm">Snare</label>
                    <input type="range" id="snareVol" min="-30" max="0" value="-6" class="w-full">
                </div>
            </div>
            <div class="flex flex-col gap-4 w-full md:w-1/2">
                <div class="flex flex-col items-center">
                    <label id="hihatLabel" for="hihatVol" class="text-sm">Hi-Hat</label>
                    <input type="range" id="hihatVol" min="-30" max="0" value="-8" class="w-full">
                </div>
                <div class="flex flex-col items-center">
                    <label id="tomsLabel" for="tomsVol" class="text-sm">Toms</label>
                    <input type="range" id="tomsVol" min="-30" max="0" value="-10" class="w-full">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use a simple, custom modal for alerts
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #334155;
                color: #e2e8f0;
                padding: 20px 40px;
                border-radius: 8px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.5);
                z-index: 1000;
                text-align: center;
                max-width: 80vw;
            `;
            modal.innerHTML = `
                <p class="mb-4">${message}</p>
                <button onclick="this.parentNode.remove()" class="bg-violet-700 hover:bg-violet-600 text-white font-bold py-1 px-4 rounded-lg">OK</button>
            `;
            document.body.appendChild(modal);
        }
        
        // This check ensures that the rest of the script only runs if Tone.js has loaded successfully.
        if (typeof Tone !== 'undefined') {
            // Drum sounds (using Tone.js synths for a self-contained app)
            const kickSynth = new Tone.MembraneSynth().toDestination();
            const snareSynth = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.0, release: 0.01 }
            }).toDestination();
            const hihatSynth = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.001, decay: 0.05, sustain: 0.0, release: 0.01 }
            }).toDestination();
            const tomSynth = new Tone.MembraneSynth({
                octaves: 4,
                pitchDecay: 0.05,
            }).toDestination();
            
            const drums = {
                kick: kickSynth,
                snare: snareSynth,
                hihat: hihatSynth,
                toms: tomSynth,
            };
    
            const drumLabels = ['Kick', 'Snare', 'Hi-Hat', 'Toms'];
            const drumSynths = [kickSynth, snareSynth, hihatSynth, tomSynth];
            
            let isPlaying = false;
            let drumPattern = [];
            let totalMeasures = 4; // Initial value
    
            const playPauseBtn = document.getElementById('playPauseBtn');
            const generateBtn = document.getElementById('generateBtn');
            const tempoSlider = document.getElementById('tempoSlider');
            const tempoDisplay = document.getElementById('tempoDisplay');
            const measuresDisplay = document.getElementById('measuresDisplay');
    
            // Initial setup for the transport
            Tone.Transport.loop = true;
            Tone.Transport.loopStart = '0m';
    
            // Function to flash a drum label
            function flashDrumLabel(drumName) {
                const label = document.getElementById(`${drumName}Label`);
                if (label) {
                    label.classList.add('flash');
                    setTimeout(() => {
                        label.classList.remove('flash');
                    }, 100); // Flash for 100ms
                }
            }
    
            // Event listener for the generate button
            generateBtn.addEventListener('click', async () => {
                try {
                    // Stop the transport if it's running
                    if (isPlaying) {
                        Tone.Transport.stop();
                    }
                    
                    // Start audio context if it's not running
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                        showCustomAlert("Audio context started. Click OK to continue.");
                    }
                    
                    // Generate a new pattern
                    generateNewPattern();
                    
                    // Start the transport and update UI to show it's playing
                    Tone.Transport.start();
                    isPlaying = true;
                    playPauseBtn.textContent = 'Pause';
                    playPauseBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                    playPauseBtn.classList.add('bg-red-600', 'hover:bg-red-500');
                } catch (error) {
                    console.error("An error occurred during pattern generation or playback:", error);
                    showCustomAlert(`An error occurred. Check the console for details: ${error.message}`);
                }
            });
    
            // Event listener for the play/pause button
            playPauseBtn.addEventListener('click', async () => {
                try {
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                        showCustomAlert("Audio context started. Click OK to continue.");
                    }
        
                    isPlaying = !isPlaying;
                    if (isPlaying) {
                        Tone.Transport.start();
                        playPauseBtn.textContent = 'Pause';
                        playPauseBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                        playPauseBtn.classList.add('bg-red-600', 'hover:bg-red-500');
                    } else {
                        Tone.Transport.pause();
                        playPauseBtn.textContent = 'Play';
                        playPauseBtn.classList.remove('bg-red-600', 'hover:bg-red-500');
                        playPauseBtn.classList.add('bg-green-600', 'hover:bg-green-500');
                    }
                } catch (error) {
                    console.error("An error occurred with the play/pause functionality:", error);
                    showCustomAlert(`An error occurred. Check the console for details: ${error.message}`);
                }
            });
    
            // Event listener for tempo slider
            tempoSlider.addEventListener('input', (e) => {
                const newTempo = parseInt(e.target.value, 10);
                Tone.Transport.bpm.value = newTempo;
                tempoDisplay.textContent = `${newTempo} BPM`;
            });
            
            // Volume sliders
            document.getElementById('kickVol').addEventListener('input', (e) => {
                kickSynth.volume.value = e.target.value;
            });
            document.getElementById('snareVol').addEventListener('input', (e) => {
                snareSynth.volume.value = e.target.value;
            });
            document.getElementById('hihatVol').addEventListener('input', (e) => {
                hihatSynth.volume.value = e.target.value;
            });
            document.getElementById('tomsVol').addEventListener('input', (e) => {
                tomSynth.volume.value = e.target.value;
            });
    
            function generateNewPattern() {
                // Clear any existing pattern from the Tone.Transport
                Tone.Transport.cancel();
                
                // Randomly determine the total number of measures (1-8)
                totalMeasures = Math.floor(Math.random() * 8) + 1;
                
                // Update the display with the new number of measures
                measuresDisplay.textContent = totalMeasures;
                
                // Re-configure the transport loop length
                Tone.Transport.loopEnd = `${totalMeasures}m`;
    
                // Clear the old pattern
                drumPattern = [];
                
                // For each drum, generate a random pattern
                drumLabels.forEach(() => {
                    const hitsPerMeasure = Math.floor(Math.random() * 8) + 1; // 1-8 hits per measure
                    const pattern = [];
                    
                    for (let measure = 0; measure < totalMeasures; measure++) {
                        const positions = new Set(); // Use a Set to ensure unique positions
                        while (positions.size < hitsPerMeasure) {
                            positions.add(Math.floor(Math.random() * 16)); // 16th notes
                        }
                        positions.forEach(pos => {
                            pattern.push(`${measure}:${Math.floor(pos / 4)}:${pos % 4}`);
                        });
                    }
                    drumPattern.push(pattern);
                });
                
                // Create a new Tone.Part for the new pattern
                drumPattern.forEach((pattern, drumIndex) => {
                    const synth = drumSynths[drumIndex];
                    const drumName = drumLabels[drumIndex].toLowerCase().replace('-', '');
                    
                    const part = new Tone.Part((time) => {
                        // Trigger the drum sound
                        if (drumLabels[drumIndex] === 'Snare' || drumLabels[drumIndex] === 'Hi-Hat') {
                            synth.triggerAttackRelease('8n', time);
                        } else {
                            synth.triggerAttackRelease('C2', '8n', time); // Kick and Toms
                        }
                        // Flash the label when the drum plays
                        Tone.Draw.schedule(() => flashDrumLabel(drumName), time);
                    }, pattern);
                    part.start(0);
                });
            }
            
            // Initial generation on page load
            window.onload = generateNewPattern;
        } else {
            // If Tone.js is not loaded, show an alert.
            showCustomAlert("Error: Tone.js library failed to load. Please try refreshing the page.");
        }
    </script>
</body>
</html>

